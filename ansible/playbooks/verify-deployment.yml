---
- name: Verify Website Deployment
  hosts: localhost
  connection: local
  gather_facts: no
  
  vars:
    check_interval: 5
    max_retries: 12
    
  tasks:
    - name: Check if deployment info exists
      stat:
        path: "{{ playbook_dir }}/../deployment-info.txt"
      register: deployment_file
      
    - name: Fail if no deployment found
      fail:
        msg: "No deployment info found. Deploy first using ansible-only-deploy.yml"
      when: not deployment_file.stat.exists
      
    - name: Read deployment info
      slurp:
        src: "{{ playbook_dir }}/../deployment-info.txt"
      register: deployment_content
      
    - name: Extract website URL
      set_fact:
        website_url: "{{ deployment_content.content | b64decode | regex_search('Website URL: (.+)', '\\1') | first }}"
        
    - name: Display verification info
      debug:
        msg:
          - "========================================="
          - "Verifying Website Deployment"
          - "========================================="
          - "URL: {{ website_url }}"
          
    - name: Wait for website to be accessible
      uri:
        url: "{{ website_url }}"
        method: GET
        status_code: 200
        timeout: 10
      register: website_check
      retries: "{{ max_retries }}"
      delay: "{{ check_interval }}"
      until: website_check.status == 200
      
    - name: Check website content
      uri:
        url: "{{ website_url }}"
        method: GET
        return_content: yes
      register: website_content
      
    - name: Verify HTML content
      assert:
        that:
          - "'StudyVerse' in website_content.content or 'Online Courses' in website_content.content"
        success_msg: "✅ Website content verified successfully"
        fail_msg: "❌ Website content verification failed"
        
    - name: Display verification results
      debug:
        msg:
          - "========================================="
          - "✅ VERIFICATION SUCCESSFUL!"
          - "========================================="
          - "Status Code: {{ website_check.status }}"
          - "Response Time: {{ website_check.elapsed }}s"
          - "Content Length: {{ website_content.content | length }} bytes"
          - ""
          - "Website is live and accessible!"
